# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    environment: dev #Selection of the Environment
    steps:
      # Check Out the README file to workspace
      - name: Checkout README file
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            README.md
          sparse-checkout-cone-mode: true

      # Read Content from README and build the query
      - name: Read Content from README and Build GRAPHQL_QUERY
        env:
          WIKI_API_TOKEN: ${{ secrets.WIKI_API_TOKEN }}
          WIKI_API_URL: ${{ vars.WIKI_API_URL }}
          WIKI_PAGE_ID: ${{ vars.WIKI_PAGE_ID }}
          PAGE_PATH: ${{ vars.PAGE_PATH }}
        run: |
          echo "üîç Reading README.md content..."
          CONTENT=$(cat README.md | jq -Rs .)
          echo "‚úÖ README content loaded."

          echo "üîß Preparing GraphQL query..."
          GRAPHQL_QUERY=$(cat <<'EOF'
          mutation UpdatePage($id: Int!, $content: String!, $path: String!) {
            pages {
              update(
                id: $id,
                content: $content,
                description: "README atualizado",
                editor: "markdown",
                isPrivate: false,
                isPublished: true,
                locale: "en",
                path: $path,
                tags: ["updated"]
              ) {
                responseResult {
                  succeeded
                  slug
                  message
                }
              }
            }
          }
          EOF
          )
          echo "‚úÖ GraphQL query prepared."

          echo $GRAPHQL_QUERY
      
      
      # Upload to Wiki
      - name: Upload README.md to Wiki.js
        run: |
          echo "üì¶ Building JSON payload..."
          curl -X POST "$WIKI_API_URL" \
            -H "Authorization: Bearer $WIKI_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg query "$GRAPHQL_QUERY" \
              --argjson variables "{\"id\": $WIKI_PAGE_ID, \"content\": $CONTENT, \"path\": $PATH}" \
              '{query: $query, variables: $variables}')"
          echo "‚úÖ JSON payload built:"
          echo "$JSON_PAYLOAD"
          
          echo "üöÄ Sending request to Wiki.js API..."

